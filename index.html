<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel de Administraci√≥n - Sal√≥n de Eventos</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #f9f9f9; }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { color: #333; }
    button, select, input {
      padding: 8px 12px;
      margin: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    th { background-color: #f4f4f4; }
    .form-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }
    .form-section.visible { display: block; }
    .estado.consulta { background-color: #fff3cd; }
    .estado.confirmada { background-color: #d4edda; }
    .estado.cancelada { background-color: #f8d7da; }
    label { display: inline-block; width: 150px; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Formulario de Login -->
    <div id="loginSection" style="max-width: 400px; margin: 100px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
      <h2>üîí Iniciar Sesi√≥n</h2>
      <label for="loginUsuario">Usuario:</label>
      <input type="text" id="loginUsuario" required style="width:100%; padding:8px; margin:5px 0;" /><br>
      
      <label for="loginPassword">Contrase√±a:</label>
      <input type="password" id="loginPassword" required style="width:100%; padding:8px; margin:5px 0;" /><br>
      
      <button id="btnLogin" style="width:100%; padding:10px; margin-top:10px;">Ingresar</button>
      <p id="loginError" style="color:red; margin-top:10px;"></p>
    </div>

    <!-- Panel principal (oculto hasta loguearse) -->
    <div id="mainPanel" style="display:none;">
      <h1>Panel de Gesti√≥n de Reservas</h1>

      <!-- Bot√≥n para abrir formulario -->
      <button id="toggleFormBtn">‚ûï Nueva Reserva</button>
      <div id="mensajeGlobal" style="margin: 10px 0; color: green; font-weight: bold;"></div>

      <!-- Filtro por fechas -->
      <div style="margin: 15px 0; padding: 10px; background: #f0f0f0; border-radius: 6px;">
        <h4>Filtrar por fecha</h4>
        <label for="filtroDesde">Desde:</label>
        <input type="date" id="filtroDesde" />

        <label for="filtroHasta">Hasta:</label>
        <input type="date" id="filtroHasta" />

        <button id="btnFiltrar">üîç Filtrar</button>
        <button id="btnLimpiarFiltro">üóëÔ∏è Limpiar</button>
      </div>

      <button id="btnEstadisticas" style="margin-top: 10px;">üìä Mostrar Estad√≠sticas</button>
      <div id="panelEstadisticas" style="display:none; margin-top: 15px; padding: 15px; background:#e9f7ef; border-radius:8px;">
        <h4>Estad√≠sticas del per√≠odo seleccionado</h4>
        <p><strong>Total de reservas:</strong> <span id="totalReservas">0</span></p>
        <div id="estadosStats"></div>
      </div>

      <!-- Formulario de nueva reserva (oculto por defecto) -->
      <div id="nuevaReservaForm" class="form-section">
        <h3>Agregar Nueva Reserva</h3>
        <form id="formularioNueva">
          <label for="nombre">Nombre:</label>
          <input type="text" id="nombre" required /><br>

          <label for="telefono">Tel√©fono:</label>
          <input type="tel" id="telefono" required /><br>

          <label for="fechaevento">Fecha:</label>
          <input type="date" id="fechaevento" required /><br>

          <label for="desde">Desde:</label>
          <select id="desde" required></select><br>

          <label for="hasta">Hasta:</label>
          <select id="hasta" required></select><br>

          <label for="tipoevento">Tipo de evento:</label>
          <select id="tipoevento" required>
            <option value="">-- Seleccione --</option>
            <option value="cumplea√±os">Cumplea√±os</option>
            <option value="baby shower">Baby Shower</option>
            <option value="quince">Quince a√±os</option>
            <option value="casamiento">Casamiento</option>
            <option value="bautismo">Bautismo</option>
            <option value="primera comunion">Primera comuni√≥n</option>
            <option value="aniversario">Aniversario</option>
            <option value="corporativo">Evento corporativo</option>
            <option value="otro">Otro</option>
          </select><br><br>

          <button type="submit">Guardar Reserva</button>
          <button type="button" id="cancelarBtn">Cancelar</button>
        </form>
      </div>

      <!-- Tabla de reservas -->
      <div id="loading">Cargando reservas...</div>
      <table id="reservasTable" style="display:none;">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Tel√©fono</th>
            <th>Fecha</th>
            <th>Horario</th>
            <th>Tipo</th>
            <th>Estado</th>
	    <th>Usuario</th>
            <th>Acci√≥n</th>
          </tr>
        </thead>
        <tbody id="reservasBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // üîë Configuraci√≥n de Supabase
    const SUPABASE_URL = 'https://tpffbvtzaxzrckevtxei.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_uV6r9_VSg0SXy3o31oROsQ_g0BFPpBE';

    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let reservasCargadas = [];
    let usuarioLogueado = null;
    const ESTADOS = ['consulta', 'confirmada', 'cancelada'];

    // === Funciones principales ===
    function llenarSelectHoras(selectId) {
      const select = document.getElementById(selectId);
      if (!select) return;
      select.innerHTML = '<option value="">-- Hora --</option>';
      for (let i = 0; i < 48; i++) {
        const totalMinutos = i * 30;
        const horas = Math.floor(totalMinutos / 60) % 24;
        const minutos = totalMinutos % 60;
        const horaStr = String(horas).padStart(2, '0');
        const minStr = String(minutos).padStart(2, '0');
        const valor = `${horaStr}:${minStr}`;
        const option = document.createElement('option');
        option.value = valor;
        option.textContent = valor;
        select.appendChild(option);
      }
    }

    function formatearFecha(fecha) {
      const a√±o = fecha.getFullYear();
      const mes = String(fecha.getMonth() + 1).padStart(2, '0');
      const dia = String(fecha.getDate()).padStart(2, '0');
      return `${a√±o}-${mes}-${dia}`;
    }

    async function cargarReservas(fechaDesde = null, fechaHasta = null) {
  document.getElementById('loading').innerText = 'Cargando...';
  let query = supabaseClient.from('Reservas').select('*,usuarios!inner(nombre_usuario)');
  if (fechaDesde) query = query.gte('FechaEvento', fechaDesde);
  if (fechaHasta) query = query.lte('FechaEvento', fechaHasta);
  query = query.order('FechaEvento', { ascending: true });
  const { data, error } = await query;

  if (error) {
    document.getElementById('loading').innerText = 'Error: ' + error.message;
    return;
  }

  reservasCargadas = data;
  const tbody = document.getElementById('reservasBody');
  tbody.innerHTML = '';

  data.forEach(reserva => {
    const row = document.createElement('tr');
    row.className = `estado ${reserva.Estado}`;
    const puedeEditar = reserva.usuario_id === usuarioLogueado.id;
    
    // Bot√≥n de guardar estado
    const botonEstadoHTML = puedeEditar 
      ? `<button class="guardar-btn" data-id="${reserva.id}">Guardar</button>`
      : `<span title="Solo el creador puede editar">üîí</span>`;

    // Enlace al PDF
    let pdfHTML = '';
    if (reserva.archivo_pdf) {
      const pdfUrl = `${SUPABASE_URL}/storage/v1/object/public/reservas-pdf/${reserva.archivo_pdf}`;
      pdfHTML = `<a href="${pdfUrl}" target="_blank" style="display:inline-block; padding:4px 8px; background:#007bff; color:white; text-decoration:none; border-radius:4px;">üìÑ Ver PDF</a>`;
    } else {
      pdfHTML = `<button class="subir-pdf-btn" data-id="${reserva.id}" ${puedeEditar ? '' : 'disabled'} style="padding:4px 8px; background:#28a745; color:white; border:none; border-radius:4px; cursor:pointer;">üìé Subir PDF</button>`;
    }

    row.innerHTML = `
      <td>${reserva.Nombre}</td>
      <td>${reserva.Telefono}</td>
      <td>${reserva.FechaEvento}</td>
      <td>${reserva.Desde} - ${reserva.Hasta}</td>
      <td>${reserva.TipoEvento}</td>
      <td>
        <select class="estado-select" data-id="${reserva.id}" ${puedeEditar ? '' : 'disabled'}>
          ${ESTADOS.map(e => 
            `<option value="${e}" ${reserva.Estado === e ? 'selected' : ''}>${e}</option>`
          ).join('')}
        </select>
      </td>
      <td>${reserva.usuarios?.nombre_usuario || 'Sin usuario'}</td>
      <td>
        ${botonEstadoHTML}<br><br>
        ${pdfHTML}
      </td>
    `;
    tbody.appendChild(row);
  });

  document.getElementById('loading').style.display = 'none';
  document.getElementById('reservasTable').style.display = 'table';
}

    // Guardar cambio de estado
    document.addEventListener('click', async (e) => {
      if (e.target.classList.contains('guardar-btn')) {
        const id = e.target.getAttribute('data-id');
        const select = document.querySelector(`.estado-select[data-id="${id}"]`);
        const nuevoEstado = select.value;

        const { error } = await supabaseClient
          .from('Reservas')
          .update({ Estado: nuevoEstado })
          .eq('id', id);

        if (error) {
          alert('Error al actualizar: ' + error.message);
        } else {
          e.target.closest('tr').className = `estado ${nuevoEstado}`;
          mostrarMensaje('Estado actualizado correctamente.');
        }
      }
    });


    // Manejar subida de PDF
document.addEventListener('click', async (e) => {
  if (e.target.classList.contains('subir-pdf-btn')) {
    const reservaId = e.target.getAttribute('data-id');
    
    // Crear input file din√°mico
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.pdf';
    input.onchange = async (event) => {
      const file = event.target.files[0];
      if (!file) return;
      
      if (file.type !== 'application/pdf') {
        alert('Por favor, selecciona un archivo PDF.');
        return;
      }
      
      // Nombre del archivo: reserva-{id}.pdf
      const fileName = `reserva-${reservaId}.pdf`;
      
      try {
        // Subir archivo a Storage
        const { data, error } = await supabaseClient
          .storage
          .from('reservas-pdf')
          .upload(fileName, file, {
            cacheControl: '3600',
            upsert: true // Sobrescribir si existe
          });
        
        if (error) throw error;
        
        // Actualizar la reserva con la ruta del archivo
        const { error: updateError } = await supabaseClient
          .from('Reservas')
          .update({ archivo_pdf: fileName })
          .eq('id', reservaId);
          
        if (updateError) throw updateError;
        
        alert('PDF subido exitosamente.');
        cargarReservas(
          document.getElementById('filtroDesde').value || null,
          document.getElementById('filtroHasta').value || null
        );
      } catch (error) {
        console.error('Error al subir PDF:', error);
        alert('Error al subir el PDF: ' + error.message);
      }
    };
    
    input.click();
  }
});	





    // === Integraci√≥n del formulario de nueva reserva ===
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('btnLogin').addEventListener('click', async () => {
        const usuarioInput = document.getElementById('loginUsuario').value.trim();
        const passwordInput = document.getElementById('loginPassword').value;

        if (!usuarioInput || !passwordInput) {
          document.getElementById('loginError').textContent = 'Completa ambos campos.';
          return;
        }

        // Eliminar espacios al inicio y al final
  const usuario = usuarioInput.trim();
  const password = passwordInput.trim();

  console.log('Buscando:', { usuario, password });

  const { data, error } = await supabaseClient
    .from('usuarios')
    .select('id, nombre_usuario')
    .eq('nombre_usuario', usuario)
    .eq('contrasena', password);

  if (error) {
    console.error('Error:', error);
    document.getElementById('loginError').textContent = 'Error interno.';
    return;
  }

  if (data.length === 0) {
    // Depuraci√≥n: ver todos los usuarios
    const { data: todos } = await supabaseClient.from('usuarios').select('nombre_usuario, contrasena');
    console.log('Todos los usuarios:', todos);
    
    document.getElementById('loginError').textContent = 'Usuario o contrase√±a incorrectos.';
    return;
}
        usuarioLogueado = data[0];
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('mainPanel').style.display = 'block';

        // Inicializar panel
        llenarSelectHoras('desde');
        llenarSelectHoras('hasta');

        const hoy = new Date();
        const hoyStr = formatearFecha(hoy);
        const dentroDeUnA√±o = new Date(hoy);
        dentroDeUnA√±o.setDate(hoy.getDate() + 365);
        const unA√±oStr = formatearFecha(dentroDeUnA√±o);

        document.getElementById('filtroDesde').value = hoyStr;
        document.getElementById('filtroHasta').value = unA√±oStr;
        cargarReservas(hoyStr, unA√±oStr);

        // Eventos
        document.getElementById('toggleFormBtn').addEventListener('click', () => {
          const formSection = document.getElementById('nuevaReservaForm');
          formSection.classList.toggle('visible');
          document.getElementById('toggleFormBtn').textContent = 
            formSection.classList.contains('visible') ? '‚ùå Cancelar' : '‚ûï Nueva Reserva';
        });

        document.getElementById('cancelarBtn').addEventListener('click', () => {
          document.getElementById('nuevaReservaForm').classList.remove('visible');
          document.getElementById('toggleFormBtn').textContent = '‚ûï Nueva Reserva';
          document.getElementById('formularioNueva').reset();
        });

        document.getElementById('formularioNueva').addEventListener('submit', async (e) => {
          e.preventDefault();
          const nuevaReserva = {
            Nombre: document.getElementById('nombre').value,
            Telefono: document.getElementById('telefono').value,
            FechaEvento: document.getElementById('fechaevento').value,
            Desde: document.getElementById('desde').value,
            Hasta: document.getElementById('hasta').value,
            TipoEvento: document.getElementById('tipoevento').value,
            Estado: 'consulta',
            usuario_id: usuarioLogueado.id // ‚Üê asignado autom√°ticamente
          };

          const { error } = await supabaseClient
            .from('Reservas')
            .insert([nuevaReserva]);

          if (error) {
            alert('Error al guardar: ' + error.message);
          } else {
            mostrarMensaje('¬°Reserva creada exitosamente!');
            document.getElementById('formularioNueva').reset();
            document.getElementById('nuevaReservaForm').classList.remove('visible');
            document.getElementById('toggleFormBtn').textContent = '‚ûï Nueva Reserva';
            cargarReservas(
              document.getElementById('filtroDesde').value || null,
              document.getElementById('filtroHasta').value || null
            );
          }
        });

        document.getElementById('btnFiltrar').addEventListener('click', () => {
          const desde = document.getElementById('filtroDesde').value;
          const hasta = document.getElementById('filtroHasta').value;
          if (!desde && !hasta) {
            alert('Selecciona al menos una fecha.');
            return;
          }
          cargarReservas(desde || null, hasta || null);
        });

        document.getElementById('btnLimpiarFiltro').addEventListener('click', () => {
          const hoy = new Date();
          const hoyStr = formatearFecha(hoy);
          const dentroDeUnA√±o = new Date(hoy);
          dentroDeUnA√±o.setDate(hoy.getDate() + 365);
          const unA√±oStr = formatearFecha(dentroDeUnA√±o);
          
          document.getElementById('filtroDesde').value = hoyStr;
          document.getElementById('filtroHasta').value = unA√±oStr;
          cargarReservas(hoyStr, unA√±oStr);
        });

        document.getElementById('btnEstadisticas').addEventListener('click', mostrarEstadisticas);
      });
    });

    function mostrarMensaje(texto) {
      const msg = document.getElementById('mensajeGlobal');
      msg.textContent = texto;
      setTimeout(() => msg.textContent = '', 3000);
    }

    function mostrarEstadisticas() {
      const total = reservasCargadas.length;
      document.getElementById('totalReservas').textContent = total;

      if (total === 0) {
        document.getElementById('estadosStats').innerHTML = '<p>No hay reservas en este per√≠odo.</p>';
        document.getElementById('panelEstadisticas').style.display = 'block';
        return;
      }

      const conteo = { consulta: 0, confirmada: 0, cancelada: 0 };
      reservasCargadas.forEach(r => {
        if (conteo.hasOwnProperty(r.Estado)) {
          conteo[r.Estado]++;
        }
      });

      let html = '<ul style="list-style:none; padding:0;">';
      for (const [estado, cantidad] of Object.entries(conteo)) {
        const porcentaje = total > 0 ? ((cantidad / total) * 100).toFixed(1) : 0;
        const label = {
          'consulta': 'Consulta',
          'confirmada': 'Confirmada',
          'cancelada': 'Cancelada'
        }[estado] || estado;

        const color = {
          'consulta': '#ffc107',
          'confirmada': '#28a745',
          'cancelada': '#dc3545'
        }[estado] || '#6c757d';

        html += `
          <li style="margin:8px 0;">
            <strong>${label}:</strong> ${cantidad} (${porcentaje}%)
            <div style="width:100%; height:12px; background:#eee; border-radius:4px; margin-top:4px;">
              <div style="width:${porcentaje}%; height:100%; background:${color}; border-radius:4px;"></div>
            </div>
          </li>
        `;
      }
      html += '</ul>';

      document.getElementById('estadosStats').innerHTML = html;
      document.getElementById('panelEstadisticas').style.display = 'block';
    }
  </script>
</body>
</html>